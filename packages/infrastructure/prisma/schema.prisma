// Prisma schema for Dykstra Funeral Home Family Portal
// Provider: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Funeral Home (Multi-tenant support)
model FuneralHome {
  id        String   @id @default(cuid())
  name      String
  address   String?
  city      String?
  state     String?
  zip       String?
  phone     String?
  email     String?
  website   String?
  settings  Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cases               Case[]
  users               User[]
  productCatalog      ProductCatalog[]
  serviceCatalog      ServiceCatalog[]
  contractTemplates   ContractTemplate[]
  leads               Lead[]
  contacts            Contact[]
  campaigns           Campaign[]
  interactions        Interaction[]
  referralSources     ReferralSource[]
  familyRelationships FamilyRelationship[]
  emails              Email[]
  calendarEvents      CalendarEvent[]
  phoneCalls          PhoneCall[]

  @@map("funeral_homes")
}

// Users (family members, staff, admins)
model User {
  id            String    @id @default(cuid())
  funeralHomeId String?
  email         String    @unique
  name          String
  phone         String?
  role          UserRole
  passwordHash  String? // Nullable for magic link auth
  emailVerified DateTime?
  preferences   Json?     @default("{}") // Notification preferences and other user settings
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  funeralHome       FuneralHome?       @relation(fields: [funeralHomeId], references: [id])
  caseMemberships   CaseMember[]
  createdCases      Case[]             @relation("CreatedCases")
  createdContracts  Contract[]
  signatures        Signature[]
  payments          Payment[]
  uploadedPhotos    Photo[]
  uploadedVideos    Video[]
  createdTasks      Task[]             @relation("CreatedTasks")
  assignedTasks     Task[]             @relation("AssignedTasks")
  auditLogs         AuditLog[]
  internalNotes     InternalNote[]
  sentInvitations   FamilyInvitation[]
  contractTemplates ContractTemplate[]
  assignedLeads     Lead[]             @relation("AssignedLeads")
  staffInteractions Interaction[]      @relation("StaffInteractions")
  oauthTokens       OAuthToken[]
  calendarEvents    CalendarEvent[]    @relation("CalendarEventCreator")
  phoneCalls        PhoneCall[]        @relation("PhoneCallStaff")

  @@index([email])
  @@index([funeralHomeId])
  @@map("users")
}

enum UserRole {
  FAMILY_PRIMARY
  FAMILY_MEMBER
  STAFF // Staff member (read-only access to cases)
  DIRECTOR // Funeral director (full case management)
  ADMIN // System administrator (full access)
  FUNERAL_DIRECTOR // Deprecated: use DIRECTOR instead
}

// Case (funeral case / arrangement)
// SCD Type 2: Tracks complete history of case changes for audit/legal compliance
model Case {
  id          String    @id @default(cuid()) // Row ID (technical key)
  businessKey String // Immutable business identifier
  version     Int       @default(1) // Version number (increments on each change)
  validFrom   DateTime  @default(now()) // When this version became effective
  validTo     DateTime? // When this version was superseded (null = current)
  isCurrent   Boolean   @default(true) // Fast lookup for current version

  funeralHomeId       String
  decedentName        String
  decedentDateOfBirth DateTime?
  decedentDateOfDeath DateTime?
  type                CaseType
  status              CaseStatus
  serviceType         ServiceType?
  serviceDate         DateTime?
  arrangements        Json?        @default("{}")
  createdAt           DateTime     @default(now()) // When this case was originally created
  updatedAt           DateTime     @updatedAt // When this version was created
  createdBy           String

  funeralHome       FuneralHome        @relation(fields: [funeralHomeId], references: [id])
  creator           User               @relation("CreatedCases", fields: [createdBy], references: [id])
  members           CaseMember[]
  contracts         Contract[]
  payments          Payment[]
  memorials         Memorial[]
  documents         Document[]
  tasks             Task[]
  internalNotes     InternalNote[]
  familyInvitations FamilyInvitation[]
  convertedFromLead Lead[]             @relation("ConvertedFromLead")
  interactions      Interaction[]
  emails            Email[]
  calendarEvents    CalendarEvent[]
  phoneCalls        PhoneCall[]

  @@unique([businessKey, version])
  @@index([businessKey, isCurrent]) // Fast current version lookup
  @@index([validFrom, validTo]) // Temporal queries
  @@index([funeralHomeId])
  @@index([status])
  @@index([serviceDate])
  @@map("cases")
}

enum CaseType {
  AT_NEED
  PRE_NEED
  INQUIRY
}

enum CaseStatus {
  INQUIRY
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum ServiceType {
  TRADITIONAL_BURIAL
  TRADITIONAL_CREMATION
  MEMORIAL_SERVICE
  DIRECT_BURIAL
  DIRECT_CREMATION
  CELEBRATION_OF_LIFE
}

// Case members (family members associated with a case)
model CaseMember {
  id          String         @id @default(cuid())
  caseId      String
  userId      String
  role        CaseMemberRole
  permissions Json           @default("{}")
  invitedAt   DateTime       @default(now())
  acceptedAt  DateTime?

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([caseId, userId])
  @@index([caseId])
  @@index([userId])
  @@map("case_members")
}

enum CaseMemberRole {
  PRIMARY_CONTACT
  FAMILY_MEMBER
}

// Contract
// SCD Type 2: Immutable once signed - critical for legal compliance and ESIGN Act
model Contract {
  id              String    @id @default(cuid()) // Row ID (technical key)
  businessKey     String // Immutable business identifier
  temporalVersion Int       @default(1) // SCD2 version (renamed from version)
  validFrom       DateTime  @default(now()) // When this version became effective
  validTo         DateTime? // When this version was superseded (null = current)
  isCurrent       Boolean   @default(true) // Fast lookup for current version

  caseId             String
  contractVersion    Int            @default(1) // Business version (e.g. v1.0, v2.0)
  status             ContractStatus
  services           Json           @default("[]")
  products           Json           @default("[]")
  subtotal           Decimal        @db.Decimal(10, 2)
  tax                Decimal        @default(0) @db.Decimal(10, 2)
  totalAmount        Decimal        @db.Decimal(10, 2)
  termsAndConditions String         @db.Text
  createdAt          DateTime       @default(now()) // When this contract was originally created
  updatedAt          DateTime       @updatedAt // When this version was created
  createdBy          String

  case       Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  creator    User        @relation(fields: [createdBy], references: [id])
  signatures Signature[]

  @@unique([businessKey, temporalVersion]) // Each temporal version is unique
  @@index([businessKey, isCurrent]) // Fast current version lookup
  @@index([validFrom, validTo]) // Temporal queries
  @@index([caseId])
  @@index([status])
  @@map("contracts")
}

enum ContractStatus {
  DRAFT
  PENDING_REVIEW
  PENDING_SIGNATURES
  FULLY_SIGNED
  CANCELLED
}

// Signature (ESIGN Act compliant)
// SCD Type 2: Signatures are immutable by law - must never be modified or deleted
model Signature {
  id          String    @id @default(cuid()) // Row ID (technical key)
  businessKey String // Immutable business identifier
  version     Int       @default(1) // Version number (should always be 1 for signatures)
  validFrom   DateTime  @default(now()) // When signature was created
  validTo     DateTime? // Should always be null (signatures never expire)
  isCurrent   Boolean   @default(true) // Should always be true (signatures immutable)

  contractId      String
  signerId        String
  signerName      String
  signerEmail     String
  signedAt        DateTime @default(now()) // Legal timestamp of signature
  ipAddress       String // ESIGN Act requirement
  userAgent       String   @db.Text // ESIGN Act requirement
  signatureData   String   @db.Text // Base64 signature image (immutable)
  consentText     String   @db.Text // Exact consent text shown to signer
  consentAccepted Boolean  @default(false) // ESIGN Act requirement

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  signer   User     @relation(fields: [signerId], references: [id])

  @@unique([businessKey, version]) // Enforce single version
  @@index([businessKey, isCurrent]) // Fast lookup
  @@index([validFrom]) // Temporal queries
  @@index([contractId])
  @@index([signerId])
  @@map("signatures")
}

// Payment
// SCD Type 2: Payment history must be immutable for accounting/audit compliance
model Payment {
  id          String    @id @default(cuid()) // Row ID (technical key)
  businessKey String // Immutable business identifier
  version     Int       @default(1) // Version number (tracks status changes)
  validFrom   DateTime  @default(now()) // When this version became effective
  validTo     DateTime? // When this version was superseded (null = current)
  isCurrent   Boolean   @default(true) // Fast lookup for current version

  caseId                String
  amount                Decimal       @db.Decimal(10, 2) // Immutable after creation
  method                PaymentMethod // Immutable after creation
  status                PaymentStatus // Can change (pendingâ†’succeeded/failed)
  stripePaymentIntentId String?
  stripePaymentMethodId String?
  receiptUrl            String?
  failureReason         String?       @db.Text
  notes                 String?       @db.Text
  createdAt             DateTime      @default(now()) // When this payment was originally created
  updatedAt             DateTime      @updatedAt // When this version was created
  createdBy             String

  case    Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  creator User @relation(fields: [createdBy], references: [id])

  @@unique([businessKey, version]) // Each version is unique
  @@index([businessKey, isCurrent]) // Fast current version lookup
  @@index([validFrom, validTo]) // Temporal queries
  @@index([caseId])
  @@index([status])
  @@map("payments")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  ACH
  CHECK
  CASH
  INSURANCE_ASSIGNMENT
  PAYMENT_PLAN
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

// Payment Plan (for installment payments)
model PaymentPlan {
  id                   String            @id @default(cuid())
  caseId               String
  totalAmount          Decimal           @db.Decimal(10, 2)
  downPayment          Decimal           @db.Decimal(10, 2)
  remainingBalance     Decimal           @db.Decimal(10, 2)
  numberOfInstallments Int
  installmentAmount    Decimal           @db.Decimal(10, 2)
  frequency            PaymentFrequency
  startDate            DateTime
  nextPaymentDue       DateTime?
  status               PaymentPlanStatus @default(ACTIVE)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  createdBy            String

  installments PaymentPlanInstallment[]

  @@index([caseId])
  @@index([status])
  @@map("payment_plans")
}

// Payment Plan Installment
model PaymentPlanInstallment {
  id                String                       @id @default(cuid())
  paymentPlanId     String
  installmentNumber Int
  amount            Decimal                      @db.Decimal(10, 2)
  dueDate           DateTime
  status            PaymentPlanInstallmentStatus @default(PENDING)
  paidDate          DateTime?
  paymentId         String? // Link to actual Payment record
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt

  paymentPlan PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([status])
  @@map("payment_plan_installments")
}

enum PaymentFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
}

enum PaymentPlanStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  DEFAULTED
}

enum PaymentPlanInstallmentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

// Insurance Assignment (for insurance claim tracking)
model InsuranceAssignment {
  id               String                    @id @default(cuid())
  caseId           String
  insuranceCompany String
  policyNumber     String
  policyHolderName String
  assignedAmount   Decimal                   @db.Decimal(10, 2)
  claimNumber      String?
  status           InsuranceAssignmentStatus @default(PENDING)
  submittedDate    DateTime?
  approvedDate     DateTime?
  paidDate         DateTime?
  notes            String?                   @db.Text
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  createdBy        String

  @@index([caseId])
  @@index([status])
  @@map("insurance_assignments")
}

enum InsuranceAssignmentStatus {
  PENDING
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  PARTIALLY_APPROVED
  DENIED
  PAID
  CANCELLED
}

// Memorial page
model Memorial {
  id                String   @id @default(cuid())
  caseId            String   @unique
  slug              String   @unique
  isPublic          Boolean  @default(true)
  allowPhotoUploads Boolean  @default(true)
  allowTributes     Boolean  @default(true)
  allowGuestbook    Boolean  @default(true)
  theme             String   @default("default")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  case             Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  photos           Photo[]
  videos           Video[]
  tributes         Tribute[]
  guestbookEntries GuestbookEntry[]

  @@index([slug])
  @@map("memorials")
}

// Photo
// SCD Type 2: Photo metadata changes (caption edits) are tracked with version history
model Photo {
  id          String    @id @default(cuid()) // Row ID (technical key)
  businessKey String // Immutable business identifier
  version     Int       @default(1) // Version number (increments on caption edit)
  validFrom   DateTime  @default(now()) // When this version became effective
  validTo     DateTime? // When this version was superseded (null = current)
  isCurrent   Boolean   @default(true) // Fast lookup for current version

  memorialId   String
  caseId       String
  url          String
  storageKey   String // S3/Vercel Blob key for deletion
  thumbnailUrl String?
  caption      String?  @db.Text
  uploadedBy   String
  uploadedAt   DateTime @default(now()) // When photo was originally uploaded
  width        Int?
  height       Int?
  fileSize     Int
  mimeType     String
  createdAt    DateTime @default(now()) // When this photo was originally created
  updatedAt    DateTime @updatedAt // When this version was created

  memorial Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)
  uploader User     @relation(fields: [uploadedBy], references: [id])

  @@unique([businessKey, version]) // Each version is unique
  @@index([businessKey, isCurrent]) // Fast current version lookup
  @@index([validFrom, validTo]) // Temporal queries
  @@index([memorialId, isCurrent]) // Fast memorial photos lookup
  @@index([caseId, isCurrent]) // Fast case photos lookup (for display on case page)
  @@index([uploadedBy])
  @@map("photos")
}

// Video
model Video {
  id             String   @id @default(cuid())
  memorialId     String
  url            String
  thumbnailUrl   String?
  title          String?
  description    String?  @db.Text
  uploadedBy     String
  uploadedByName String
  uploadedAt     DateTime @default(now())
  duration       Int? // in seconds
  fileSize       Int
  mimeType       String

  memorial Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)
  uploader User     @relation(fields: [uploadedBy], references: [id])

  @@index([memorialId])
  @@map("videos")
}

// Tribute message
model Tribute {
  id          String   @id @default(cuid())
  memorialId  String
  authorName  String
  authorEmail String?
  message     String   @db.Text
  isPublic    Boolean  @default(true)
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())

  memorial Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
  @@index([isApproved])
  @@map("tributes")
}

// Guestbook entry
model GuestbookEntry {
  id         String   @id @default(cuid())
  memorialId String
  name       String
  email      String?
  message    String   @db.Text
  city       String?
  state      String?  @db.Char(2)
  createdAt  DateTime @default(now())

  memorial Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
  @@map("guestbook_entries")
}

// Document
model Document {
  id        String         @id @default(cuid())
  caseId    String
  type      DocumentType
  name      String
  url       String
  fileSize  Int
  mimeType  String
  status    DocumentStatus @default(ACTIVE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@map("documents")
}

enum DocumentType {
  CONTRACT
  DEATH_CERTIFICATE
  SERVICE_PROGRAM
  INSURANCE_DOCUMENT
  RECEIPT
  OTHER
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

// Task
model Task {
  id          String     @id @default(cuid())
  caseId      String
  title       String
  description String?    @db.Text
  status      TaskStatus @default(PENDING)
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  createdBy   String

  case     Case  @relation(fields: [caseId], references: [id], onDelete: Cascade)
  creator  User  @relation("CreatedTasks", fields: [createdBy], references: [id])
  assignee User? @relation("AssignedTasks", fields: [assignedTo], references: [id])

  @@index([caseId])
  @@index([status])
  @@index([assignedTo])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Family Invitation (invite family members to portal)
// SCD Type 2: Tracks invitation status changes for audit
model FamilyInvitation {
  id          String    @id @default(cuid()) // Row ID
  businessKey String // Immutable identifier
  version     Int       @default(1) // Version number
  validFrom   DateTime  @default(now()) // When this version became effective
  validTo     DateTime? // When superseded
  isCurrent   Boolean   @default(true) // Current version flag

  caseId       String
  email        String
  name         String
  phone        String?
  relationship String? // Relationship to decedent
  role         CaseMemberRole @default(FAMILY_MEMBER)
  permissions  Json           @default("{}")

  status     InvitationStatus @default(PENDING)
  token      String           @unique // Secure magic link token
  expiresAt  DateTime // Token expiration
  acceptedAt DateTime?
  revokedAt  DateTime?

  sentBy    String
  createdAt DateTime @default(now()) // Original invitation time
  updatedAt DateTime @updatedAt

  case   Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [sentBy], references: [id])

  @@unique([businessKey, version])
  @@index([businessKey, isCurrent])
  @@index([validFrom, validTo])
  @@index([caseId, isCurrent])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("family_invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// Internal Note (staff-only case notes)
// SCD Type 2: Tracks edit history of notes for audit trail
model InternalNote {
  id          String    @id @default(cuid()) // Row ID (technical key)
  businessKey String // Immutable business identifier
  version     Int       @default(1) // Version number (increments on edit)
  validFrom   DateTime  @default(now()) // When this version became effective
  validTo     DateTime? // When this version was superseded (null = current)
  isCurrent   Boolean   @default(true) // Fast lookup for current version

  caseId    String
  content   String   @db.Text
  createdBy String
  createdAt DateTime @default(now()) // When note was originally created
  updatedAt DateTime @updatedAt // When this version was created

  case    Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  creator User @relation(fields: [createdBy], references: [id])

  @@unique([businessKey, version]) // Each version is unique
  @@index([businessKey, isCurrent]) // Fast current version lookup
  @@index([validFrom, validTo]) // Temporal queries
  @@index([caseId, isCurrent]) // Fast case notes lookup
  @@index([createdBy])
  @@map("internal_notes")
}

// Audit Log (immutable for compliance)
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String // e.g. "case.create", "contract.sign", "payment.process"
  entityType String // e.g. "Case", "Contract", "Payment"
  entityId   String? // ID of affected entity
  metadata   Json     @default("{}")
  ipAddress  String?
  userAgent  String?  @db.Text
  timestamp  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

// Product Catalog (caskets, urns, merchandise)
model ProductCatalog {
  id            String          @id @default(cuid())
  funeralHomeId String?
  sku           String          @unique
  name          String
  description   String          @db.Text
  category      ProductCategory
  price         Decimal         @db.Decimal(10, 2)
  imageUrl      String?
  isAvailable   Boolean         @default(true)
  metadata      Json            @default("{}")
  displayOrder  Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  funeralHome FuneralHome? @relation(fields: [funeralHomeId], references: [id])

  @@index([funeralHomeId])
  @@index([category])
  @@index([isAvailable])
  @@map("product_catalog")
}

enum ProductCategory {
  CASKET
  URN
  VAULT
  FLOWERS
  MEMORIAL_CARDS
  GUEST_BOOK
  JEWELRY
  KEEPSAKE
  MISCELLANEOUS
}

// Service Catalog (embalming, viewing, cremation, etc)
model ServiceCatalog {
  id            String      @id @default(cuid())
  funeralHomeId String?
  code          String      @unique
  name          String
  description   String      @db.Text
  serviceType   ServiceType
  price         Decimal     @db.Decimal(10, 2)
  isRequired    Boolean     @default(false)
  isAvailable   Boolean     @default(true)
  displayOrder  Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  funeralHome FuneralHome? @relation(fields: [funeralHomeId], references: [id])

  @@index([funeralHomeId])
  @@index([serviceType])
  @@index([isAvailable])
  @@map("service_catalog")
}

// Contract Template (with variable substitution)
model ContractTemplate {
  id            String       @id @default(cuid())
  funeralHomeId String?
  name          String
  description   String?
  serviceType   ServiceType?
  content       String       @db.Text
  variables     Json         @default("[]")
  isDefault     Boolean      @default(false)
  version       Int          @default(1)
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdBy     String

  funeralHome FuneralHome? @relation(fields: [funeralHomeId], references: [id])
  creator     User         @relation(fields: [createdBy], references: [id])

  @@index([funeralHomeId])
  @@index([serviceType])
  @@index([isDefault])
  @@index([isActive])
  @@map("contract_templates")
}

// ============================================================================
// CRM & Marketing System Models
// ============================================================================

// Lead (SCD Type 2)
model Lead {
  id          String    @id @default(cuid())
  businessKey String
  version     Int       @default(1)
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  isCurrent   Boolean   @default(true)

  funeralHomeId     String
  firstName         String
  lastName          String
  email             String?
  phone             String?
  status            LeadStatus
  source            LeadSource
  type              LeadType
  score             Int        @default(0)
  assignedTo        String?
  referralSourceId  String?
  notes             String?    @db.Text
  lastContactedAt   DateTime?
  convertedToCaseId String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  createdBy         String

  funeralHome    FuneralHome     @relation(fields: [funeralHomeId], references: [id])
  assignedStaff  User?           @relation("AssignedLeads", fields: [assignedTo], references: [id])
  referralSource ReferralSource? @relation(fields: [referralSourceId], references: [id])
  convertedCase  Case?           @relation("ConvertedFromLead", fields: [convertedToCaseId], references: [id])
  interactions   Interaction[]
  emails         Email[]
  phoneCalls     PhoneCall[]

  @@unique([businessKey, version])
  @@index([businessKey, isCurrent])
  @@index([validFrom, validTo])
  @@index([funeralHomeId])
  @@index([status])
  @@index([score])
  @@index([assignedTo])
  @@map("leads")
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  NURTURING
  CONVERTED
  LOST
  ARCHIVED
}

enum LeadSource {
  WEBSITE
  PHONE
  EMAIL
  REFERRAL
  SOCIAL_MEDIA
  EVENT
  DIRECT_MAIL
  OTHER
}

enum LeadType {
  AT_NEED
  PRE_NEED
  GENERAL_INQUIRY
}

// Contact (SCD Type 2)
model Contact {
  id          String    @id @default(cuid())
  businessKey String
  version     Int       @default(1)
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  isCurrent   Boolean   @default(true)

  funeralHomeId          String
  firstName              String
  lastName               String
  email                  String?
  phone                  String?
  alternatePhone         String?
  address                String?
  city                   String?
  state                  String?
  zipCode                String?
  type                   ContactType
  relationshipType       RelationshipType?
  birthDate              DateTime?
  notes                  String?            @db.Text
  doNotContact           Boolean            @default(false)
  emailOptIn             Boolean            @default(false)
  smsOptIn               Boolean            @default(false)
  tags                   String[]           @default([])
  mergedIntoContactId    String?
  // Funeral-specific enhancements
  isVeteran              Boolean            @default(false)
  militaryBranch         MilitaryBranch?
  religiousAffiliation   String?
  culturalPreferences    String[]           @default([])
  dietaryRestrictions    String[]           @default([])
  languagePreference     LanguagePreference @default(EN)
  // Grief journey tracking
  griefStage             GriefStage?
  griefJourneyStartedAt  DateTime?
  decedentRelationshipId String? // Link to FamilyRelationship
  serviceAnniversaryDate DateTime?
  lastGriefCheckIn       DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  createdBy              String

  funeralHome           FuneralHome          @relation(fields: [funeralHomeId], references: [id])
  mergedInto            Contact?             @relation("MergedContacts", fields: [mergedIntoContactId], references: [id])
  mergedContacts        Contact[]            @relation("MergedContacts")
  interactions          Interaction[]
  sourceRelationships   FamilyRelationship[] @relation("SourceContact")
  targetRelationships   FamilyRelationship[] @relation("TargetContact")
  decedentRelationships FamilyRelationship[] @relation("Decedent")
  emails                Email[]
  phoneCalls            PhoneCall[]

  @@unique([businessKey, version])
  @@index([businessKey, isCurrent])
  @@index([validFrom, validTo])
  @@index([funeralHomeId])
  @@index([email])
  @@index([phone])
  @@index([griefStage])
  @@index([serviceAnniversaryDate])
  @@map("contacts")
}

enum ContactType {
  PRIMARY
  SECONDARY
  PROFESSIONAL
  REFERRAL
}

enum RelationshipType {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  FRIEND
  CLERGY
  ATTORNEY
  OTHER
}

enum GriefStage {
  SHOCK
  DENIAL
  ANGER
  BARGAINING
  DEPRESSION
  ACCEPTANCE
}

enum MilitaryBranch {
  ARMY
  NAVY
  AIR_FORCE
  MARINES
  COAST_GUARD
  SPACE_FORCE
}

enum LanguagePreference {
  EN
  ES
  FR
  DE
  PL
  IT
  ZH
  OTHER
}

// FamilyRelationship (SCD Type 2)
// Maps relationships between contacts for family network visualization
model FamilyRelationship {
  id          String    @id @default(cuid())
  businessKey String
  version     Int       @default(1)
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  isCurrent   Boolean   @default(true)

  funeralHomeId    String
  sourceContactId  String
  targetContactId  String
  relationshipType FamilyRelationshipType
  isPrimaryContact Boolean                @default(false)
  decedentId       String? // Contact ID of deceased
  notes            String?                @db.Text
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  createdBy        String

  funeralHome   FuneralHome @relation(fields: [funeralHomeId], references: [id])
  sourceContact Contact     @relation("SourceContact", fields: [sourceContactId], references: [id])
  targetContact Contact     @relation("TargetContact", fields: [targetContactId], references: [id])
  decedent      Contact?    @relation("Decedent", fields: [decedentId], references: [id])

  @@unique([businessKey, version])
  @@index([businessKey, isCurrent])
  @@index([validFrom, validTo])
  @@index([funeralHomeId])
  @@index([sourceContactId])
  @@index([targetContactId])
  @@index([decedentId])
  @@map("family_relationships")
}

enum FamilyRelationshipType {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  GRANDCHILD
  GRANDPARENT
  NIECE_NEPHEW
  AUNT_UNCLE
  COUSIN
  IN_LAW
  STEP_RELATION
  FRIEND
  OTHER
}

// Campaign (SCD Type 2)
model Campaign {
  id          String    @id @default(cuid())
  businessKey String
  version     Int       @default(1)
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  isCurrent   Boolean   @default(true)

  funeralHomeId  String
  name           String
  description    String?        @db.Text
  type           CampaignType
  status         CampaignStatus
  subject        String?
  content        String?        @db.Text
  segmentTags    String[]       @default([])
  scheduledFor   DateTime?
  sentAt         DateTime?
  targetCount    Int            @default(0)
  sentCount      Int            @default(0)
  openedCount    Int            @default(0)
  clickedCount   Int            @default(0)
  convertedCount Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  createdBy      String

  funeralHome FuneralHome @relation(fields: [funeralHomeId], references: [id])

  @@unique([businessKey, version])
  @@index([businessKey, isCurrent])
  @@index([validFrom, validTo])
  @@index([funeralHomeId])
  @@index([status])
  @@map("campaigns")
}

enum CampaignType {
  EMAIL
  SMS
  DIRECT_MAIL
  MIXED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  ARCHIVED
}

// Interaction (immutable - no SCD2)
model Interaction {
  id            String               @id @default(cuid())
  funeralHomeId String
  leadId        String?
  contactId     String?
  caseId        String?
  type          InteractionType
  direction     InteractionDirection
  subject       String
  body          String?              @db.Text
  outcome       String?              @db.Text
  scheduledFor  DateTime?
  completedAt   DateTime?
  duration      Int?
  staffId       String
  createdAt     DateTime             @default(now())

  funeralHome   FuneralHome    @relation(fields: [funeralHomeId], references: [id])
  lead          Lead?          @relation(fields: [leadId], references: [id])
  contact       Contact?       @relation(fields: [contactId], references: [id])
  case          Case?          @relation(fields: [caseId], references: [id])
  staff         User           @relation("StaffInteractions", fields: [staffId], references: [id])
  calendarEvent CalendarEvent?
  phoneCall     PhoneCall?

  @@index([funeralHomeId])
  @@index([leadId])
  @@index([contactId])
  @@index([caseId])
  @@index([staffId])
  @@index([createdAt])
  @@map("interactions")
}

enum InteractionType {
  PHONE_CALL
  EMAIL
  MEETING
  VISIT
  NOTE
  TASK
}

enum InteractionDirection {
  INBOUND
  OUTBOUND
}

// Referral Source (SCD Type 2)
model ReferralSource {
  id          String    @id @default(cuid())
  businessKey String
  version     Int       @default(1)
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  isCurrent   Boolean   @default(true)

  funeralHomeId      String
  name               String
  type               ReferralSourceType
  contactPerson      String?
  email              String?
  phone              String?
  address            String?
  notes              String?            @db.Text
  isActive           Boolean            @default(true)
  totalReferrals     Int                @default(0)
  convertedReferrals Int                @default(0)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  createdBy          String

  funeralHome FuneralHome @relation(fields: [funeralHomeId], references: [id])
  leads       Lead[]

  @@unique([businessKey, version])
  @@index([businessKey, isCurrent])
  @@index([validFrom, validTo])
  @@index([funeralHomeId])
  @@map("referral_sources")
}

enum ReferralSourceType {
  FUNERAL_HOME
  HOSPICE
  HOSPITAL
  CLERGY
  ATTORNEY
  FAMILY
  ONLINE
  OTHER
}

// Email (immutable event log - no SCD2)
// Bi-directional email sync from Microsoft 365 / Gmail
model Email {
  id            String         @id @default(cuid())
  funeralHomeId String
  provider      EmailProvider
  externalId    String? // Provider's message ID (for deduplication)
  from          String
  to            String[]       @default([])
  cc            String[]       @default([])
  bcc           String[]       @default([])
  subject       String
  body          String         @db.Text // Plain text
  htmlBody      String?        @db.Text
  threadId      String? // For conversation threading
  inReplyTo     String? // Parent email ID
  direction     EmailDirection
  sentAt        DateTime?
  receivedAt    DateTime?
  isRead        Boolean        @default(false)
  contactId     String? // Matched contact
  leadId        String? // Matched lead
  caseId        String? // Matched case
  attachments   Json           @default("[]") // Array of attachment metadata
  createdAt     DateTime       @default(now())
  syncedBy      String? // User who triggered sync

  funeralHome FuneralHome @relation(fields: [funeralHomeId], references: [id])
  contact     Contact?    @relation(fields: [contactId], references: [id])
  lead        Lead?       @relation(fields: [leadId], references: [id])
  case        Case?       @relation(fields: [caseId], references: [id])

  @@unique([provider, externalId]) // Prevent duplicate syncs
  @@index([funeralHomeId])
  @@index([contactId])
  @@index([leadId])
  @@index([caseId])
  @@index([threadId])
  @@index([from])
  @@index([sentAt])
  @@index([receivedAt])
  @@index([createdAt])
  @@map("emails")
}

enum EmailProvider {
  MICROSOFT
  GOOGLE
  INTERNAL
}

enum EmailDirection {
  INBOUND
  OUTBOUND
}

// OAuth Token storage for email sync
model OAuthToken {
  id           String        @id @default(cuid())
  userId       String
  provider     OAuthProvider
  accessToken  String        @db.Text
  refreshToken String?       @db.Text
  expiresAt    DateTime
  scope        String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider]) // One token per provider per user
  @@index([userId])
  @@index([expiresAt])
  @@map("oauth_tokens")
}

enum OAuthProvider {
  MICROSOFT
  GOOGLE
}

// CalendarEvent (immutable event log - no SCD2)
// Synced with external calendar providers (Microsoft 365, Google Calendar)
model CalendarEvent {
  id             String           @id @default(cuid())
  funeralHomeId  String
  interactionId  String?          @unique // Optional link to Interaction
  provider       CalendarProvider
  externalId     String? // Provider's event ID
  title          String
  description    String?          @db.Text
  startTime      DateTime
  endTime        DateTime
  location       String?
  attendees      Json             @default("[]") // Array of Attendee objects
  reminders      Json             @default("[]") // Array of Reminder objects
  recurrenceRule String?          @db.Text // iCalendar RRULE format
  isCancelled    Boolean          @default(false)
  createdBy      String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  caseId         String?

  funeralHome FuneralHome  @relation(fields: [funeralHomeId], references: [id])
  interaction Interaction? @relation(fields: [interactionId], references: [id])
  case        Case?        @relation(fields: [caseId], references: [id])
  creator     User         @relation("CalendarEventCreator", fields: [createdBy], references: [id])

  @@unique([provider, externalId]) // Prevent duplicate syncs
  @@index([funeralHomeId])
  @@index([interactionId])
  @@index([caseId])
  @@index([startTime])
  @@index([endTime])
  @@index([createdBy])
  @@index([isCancelled])
  @@map("calendar_events")
}

enum CalendarProvider {
  MICROSOFT
  GOOGLE
}

// PhoneCall (immutable event log - no SCD2)
// Tracks phone calls from Twilio/RingCentral with optional recording/transcription
model PhoneCall {
  id             String        @id @default(cuid())
  funeralHomeId  String
  interactionId  String?       @unique // Optional link to Interaction
  provider       PhoneProvider
  externalCallId String? // Provider's call SID/ID
  from           String // E.164 format
  to             String // E.164 format
  direction      CallDirection
  status         CallStatus
  duration       Int? // Duration in seconds
  recordingUrl   String? // URL to call recording
  transcription  String?       @db.Text // Call transcription
  consentGiven   Boolean       @default(false) // Recording consent flag
  outcome        String?       @db.Text // Call outcome notes
  contactId      String? // Matched contact
  leadId         String? // Matched lead
  caseId         String? // Matched case
  staffId        String // Staff member who made/received call
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime      @default(now())

  funeralHome FuneralHome  @relation(fields: [funeralHomeId], references: [id])
  interaction Interaction? @relation(fields: [interactionId], references: [id])
  contact     Contact?     @relation(fields: [contactId], references: [id])
  lead        Lead?        @relation(fields: [leadId], references: [id])
  case        Case?        @relation(fields: [caseId], references: [id])
  staff       User         @relation("PhoneCallStaff", fields: [staffId], references: [id])

  @@unique([provider, externalCallId]) // Prevent duplicate logging
  @@index([funeralHomeId])
  @@index([interactionId])
  @@index([contactId])
  @@index([leadId])
  @@index([caseId])
  @@index([staffId])
  @@index([startedAt])
  @@index([createdAt])
  @@map("phone_calls")
}

enum PhoneProvider {
  TWILIO
  RINGCENTRAL
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
  CANCELLED
}
